name: Build and Release

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: windows-latest
    env:
      VERSION: ${{ github.ref_name }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if exist requirements.txt (pip install -r requirements.txt)
          pip install pyinstaller

      - name: Build portable ZIP
        shell: pwsh
        run: |
          $version = "$Env:VERSION"
          if ([string]::IsNullOrWhiteSpace($version)) { $version = "dev" }
          $scriptPath = Join-Path $Env:GITHUB_WORKSPACE "build/build_portable.ps1"
          if (Test-Path $scriptPath) {
            & $scriptPath -Version $version
          } else {
            Write-Host "No build script found; skipping portable ZIP build."
          }

      - name: Build WinMaintainScanner executable
        shell: pwsh
        run: |
          $version = "$Env:VERSION"
          if ([string]::IsNullOrWhiteSpace($version)) { $version = "dev" }
          $name = "WinMaintainScanner_{0}" -f $version
          if (Test-Path "toolkit/win_maintain.py") {
            pyinstaller --noconfirm --onefile toolkit/win_maintain.py --name $name
          } else {
            Write-Host "Source script not found; skipping PyInstaller build."
          }

      - name: Build WinMaintain menu executable
        shell: pwsh
        run: |
          $version = "$Env:VERSION"
          if ([string]::IsNullOrWhiteSpace($version)) { $version = "dev" }
          $name = "WinMaintain_{0}" -f $version
          if (Test-Path "toolkit/winmaintain_gui.py") {
            pyinstaller --noconfirm --onefile toolkit/winmaintain_gui.py --name $name --hidden-import win_maintain --hidden-import win_collect_session
          } else {
            Write-Host "GUI wrapper not found; skipping WinMaintain.exe build."
          }

      - name: Upload Release Assets
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $tag = "$Env:GITHUB_REF" -replace "refs/tags/", ""
          if ([string]::IsNullOrWhiteSpace($tag)) { $tag = "dev" }

          $zipName = "WinMaintain_Portable_{0}.zip" -f $tag
          $zipPath = Join-Path "$Env:GITHUB_WORKSPACE" "dist/$zipName"
          $exeName = "WinMaintainScanner_{0}.exe" -f $tag
          $exePath = Join-Path "$Env:GITHUB_WORKSPACE" "dist/$exeName"
          $guiName = "WinMaintain_{0}.exe" -f $tag
          $guiPath = Join-Path "$Env:GITHUB_WORKSPACE" "dist/$guiName"

          Write-Host "Uploading assets for tag $tag"
          if (Test-Path $zipPath) {
            gh release upload $tag $zipPath --clobber
          } else {
            Write-Host "Portable ZIP not found at $zipPath"
          }

          if (Test-Path $exePath) {
            gh release upload $tag $exePath --clobber
          } else {
            Write-Host "PyInstaller EXE not found at $exePath"
          }

          if (Test-Path $guiPath) {
            gh release upload $tag $guiPath --clobber
          } else {
            Write-Host "WinMaintain.exe not found at $guiPath"
          }
